#!/bin/sh
# Daemon for mbim. Restart LTE connection
#
# Thanks "yosh781" from "https://github.com/yosh781/Daemon-modem-watchdog_qmi-for-Openwrt"
# Thanks "@antonk" from "https://forum.openwrt.org/t/create-a-sample-procd-init-script/230977"

#set -x; # show this "https://forum.openwrt.org/t/qmi-ec25-v-verizon-problems/145970"

delay="5"; # idle time between connectivity checks

delay_reconnect="90"; # reconnect time after  "ifdown wan && ifup wan" re-executed script, prevent "race condition"

watchdog_debug_file="/tmp/watchdog/mbim_debug"; # create file for debug script

watchdog_block_file="/tmp/watchdog/mbim_block"; # create file for block script

atcmd_block_file="/tmp/watchdog/atcmd_block"; # block exec atcmd commands

logheader="exec: /root/watchdog_mbim:"; # logger header message

trap "exit 0" INT TERM

lteinterface=$(uci -q get network.wan)
if [ "$lteinterface" != "interface" ]; then
    logger "$logheader Interface wan not found in network config"
    exit 0
fi

lteproto=$(uci -q get network.wan.proto)
if [ "$lteproto" != "mbim" ]; then
    logger "$logheader WAN interface is not using mbim"
    exit 0
fi

count=0

while true; do

    # add varius scripts
    watchdog_predown_file="/tmp/watchdog/predown_file"; # create file for exec command pre down interface
    watchdog_postdown_file="/tmp/watchdog/postdown_file"; # create file for exec command post down interface
    watchdog_ping_test="/tmp/watchdog/ping_test"; # create file for exec ping test internet connection
    watchdog_ping_pid="/tmp/watchdog/ping_pid"

    count=$((count+1))
    status=$(ubus call service list '{ "name": "watchdog_mbim" }' | grep -c '"running": true')

    # if service is running and this file exists exec: /etc/init.d/watchdog_mbim stop
    if [ "$status" -eq 1 ]; then
        if [ -f "$watchdog_block_file" ]; then
        logger "$logheader the file /tmp/watchdog_mbim_block exists; /etc/init.d/watchdog_mbim stop; exit 0"
        /etc/init.d/watchdog_mbim stop; # from "https://forum.openwrt.org/t/start-and-stop-a-service-while-pushing-wps-button/191871/19"
        exit 0
        fi
    else
        if [ -f "$atcmd_block_file" ]; then
        rm "$atcmd_block_file"
        fi
    fi

    if [ ! -d /tmp/watchdog ]; then
        mkdir /tmp/watchdog
    fi

    # theoretically the "uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-data-status" command should respond in:
    # time uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-data-status
    # "connected"
    # real    0m 0.25s
    # user    0m 0.00s
    # sys     0m 0.00s

    ltestatus=$(uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-data-status 2> /dev/null); # return "connected"
    lteerror=$?; # return 0
    ltefind=$(echo "$ltestatus" | grep -c "\"connected\""); # return "1"

    if [ "$ltefind" -eq "0" ] || [ "$lteerror" -ne "0" ] ; then

        # uqmi does not return "connected" or uqmi not response into 20 sec
        logger "$logheader lost connection detected, or uqmi not respond into 20 sec, exec ifdown wan; ifup wan"
        if [ -n "$wanuptime" ]; then
        logger "$logheader count=$count ltestatus=$ltestatus lteerror=$lteerror wanuptime=$wanuptime delay=$delay delay_reconnec=$delay_reconnect"
        else
        logger "$logheader count=$count ltestatus=$ltestatus lteerror=$lteerror delay=$delay delay_reconnec=$delay_reconnect"
        fi

        # exec ping_test if present
        if [ -x "$watchdog_ping_test" ]; then
        if [ -f "$watchdog_debug_file" ]; then
        logger "exec: $watchdog_ping_test start"
        fi
        $watchdog_ping_test &
        fi

        # exec command predown interface if present
        if [ -x "$watchdog_predown_file" ]; then
        if [ -f "$watchdog_debug_file" ]; then
        logger "exec: $watchdog_predown_file"
        fi
        $watchdog_predown_file
        fi

        # debug mode
        if [ -f "$watchdog_debug_file" ]; then
        logger "$logheaderdebug ltestatus=$ltestatus lteerror=$lteerror ltefind=$ltefind count=$count status=$status"
        fi

        ifdown wan && ifup wan

        # block exec atcmd commands view /root/atcmd
        touch "$atcmd_block_file"
        if [ -f "$watchdog_debug_file" ]; then
        logger "exec: create $atcmd_block_file"
        fi

        sleep "$delay_reconnect"; # sleep prevent "race condition"

        # exec command post down interface if present
        if [ -x "$watchdog_postdown_file" ]; then
        if [ -f "$watchdog_debug_file" ]; then
        logger "exec: $watchdog_postdown_file"
        fi
        $watchdog_postdown_file
        fi

        if [ -f "$watchdog_debug_file" ]; then
        logger "$logheader debug end time delay_reconnec=$delay_reconnect after running postdown command if present"
        fi

        break
    fi

    # if after about 3 minutes, 180 seconds / 5 seconds of "$delay" it is still not connected it proceeds to kill the "$watchdog_ping_test" process
    # set -x; logread | grep -E "1 -eq 36|36 -eq 36"
    # Sun Aug 10 13:27:34 2025 daemon.err watchdog_mbim[5167]: + '[' 1 -eq 36 ]
    # Sun Aug 10 13:30:38 2025 daemon.err watchdog_mbim[5167]: + '[' 36 -eq 36 ]
    if [ "$count" -eq "36" ] && [ -f "$watchdog_ping_pid" ]; then
        logger "exec: kill $watchdog_ping_test process"
        kill -9 "$(cat $watchdog_ping_pid)"
        rm "$watchdog_ping_pid"
    fi

    # online status
    if [ "$ltefind" -eq "1" ] && [ "$lteerror" -eq "0" ]; then

        # discovers WAN uptime
        wanstatus=$(cat /sys/class/net/wwan0/carrier 2> /dev/null)
        if [ "$wanstatus" -eq "1" ]; then
        wanuptime=$(ubus call network.interface.wan_4 status | grep 'uptime' | grep -o '[0-9]\+')
        export wanuptime
        if [ -f "$watchdog_debug_file" ]; then
        logger "$logheader discover WAN uptime wanstatus=$wanstatus wanuptime=$wanuptime count=$count"
        fi
        fi

        # debug mode
        if [ -f "$watchdog_debug_file" ]; then
        if [ -n "$wanuptime" ]; then
        logger "$logheader debug ltestatus=$ltestatus lteerror=$lteerror ltefind=$ltefind wanuptime=$wanuptime count=$count status=$status delay=$delay"
        else
        logger "$logheader debug ltestatus=$ltestatus lteerror=$lteerror ltefind=$ltefind count=$count status=$status delay=$delay"
        fi
        fi

        # remove atcmd_block_file
        if [ -f "$atcmd_block_file" ]; then
        rm "$atcmd_block_file"
                if [ -f "$watchdog_debug_file" ]; then
                logger "exec: delete $atcmd_block_file"
                fi
        fi

    fi

    sleep "$delay"; # idle time between connectivity checks

done

exit 0
