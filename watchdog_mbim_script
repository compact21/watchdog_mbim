#!/bin/sh
# Daemon for mbim. Restart LTE connection
#
# Thanks to the work of "yosh781" from "https://github.com/yosh781/Daemon-modem-watchdog_qmi-for-Openwrt"
# Thanks "@antonk" to the support from "https://forum.openwrt.org/t/create-a-sample-procd-init-script/230977"

trap "exit 0" INT TERM

LTEINTERFACE=$(uci -q get network.wan)
if [ ${LTEINTERFACE} != "interface" ]; then
    logger "exec: /root/watchdog_mbim: Interface wan not found in network config"
    exit 0
fi

LTEPROTO=$(uci -q get network.wan.proto)
if [ ${LTEPROTO} != "mbim" ]; then
    logger "exec: /root/watchdog_mbim: WAN interface is not using mbim"
    exit 0
fi

AUTOCONNECT=$(uci -q get network.wan.autoconnect)
if [ ${AUTOCONNECT} != "1" ]; then
    logger "exec: /root/watchdog_mbim: WAN autoconnect is disabled"
    exit 0
fi

count=0

while true; do

count=$(($count+1))

    # if this file exists block flow exit 0
    if [ -f /tmp/watchdog_mbim_block ]; then
        logger "exec: /root/watchdog_mbim: the file /tmp/watchdog_mbim_block exists; service watchdog stop; exit 0"
        service watchdog stop
        exit 0
    fi

    # theoretically the "uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-data-status"
    # command should respond in this time:
    #
    # time uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-data-status
    # "connected"
    # real    0m 0.25s
    # user    0m 0.00s
    # sys     0m 0.00s
    #
    # so well below the set timeout, i preferred to set a high timeout
    # 20000 msec = 20 seconds in order to reduce any micro-disconnection anomalies.
    #

    LTESTATUS=$(uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-data-status)
    LTEERROR=$?
    LTEFIND=$(echo ${LTESTATUS} | grep "\"connected\"" | wc -l)

    # uqmi does not return "connected"
    if [ ${LTEFIND} -eq "0" ]; then
        logger "exec: /root/watchdog_mbim: lost connection detected exec ifdown wan; ifup wan"
        ifdown wan && ifup wan
        # performs a sleep allowing the connection to be reactivated without further checks during this time to avoid "race conditions"
        sleep 180
        exit 0
    fi

    # uqmi not response into 20 sec
    if [ ${LTEERROR} -ne 0 ]; then
        logger "exec: /root/watchdog_mbim: uqmi not response into 20 sec exec ifdown wan; ifup wan"
        ifdown wan && ifup wan
        # performs a sleep allowing the connection to be reactivated without further checks during this time to avoid "race conditions"
        sleep 180
        exit 0
    fi

    # if this file exists show debug interactions
    if [ -f /tmp/watchdog_mbim_debug ]; then                                       
        logger "exec: /root/watchdog_mbim debug LTESTATUS=${LTESTATUS} LTEERROR=${LTEERROR} LTEFIND=${LTEFIND} count=${count
    fi

    #
    # idle time between two connectivity checks LTEFIND=1 or LTEERROR=0
    # never exits the cycle "while true; do; done"
    #
    sleep 20
    #
    # except for start,stop,reload service events
    # service wathdog_mbim stop/start/reload
    #

done

exit 0
