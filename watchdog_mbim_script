#!/bin/sh
# Daemon for mbim. Restart LTE connection
#
# main author https://github.com/yosh781
# and some changes https://github.com/compact21

trap "logger 'exec: /usr/bin/watchdog_mbim Modem watchdog stopped'; exit 0" INT TERM

# for 600 sec from boot not exec nothing
while true; do
    if [ $(awk -F "." '{print $1}' /proc/uptime) -lt "600" ]; then
    sleep 1
    fi
done

LTEINTERFACE=$(uci -q get network.wan)
if [ ${LTEINTERFACE} != "interface" ]; then
    logger "exec: /usr/bin/watchdog_mbim Interface wan not found in network config, exiting"
    exit 0
fi

LTEPROTO=$(uci -q get network.wan.proto)
if [ ${LTEPROTO} != "mbim" ]; then
    logger "exec: /usr/bin/watchdog_mbim WAN interface is not using mbim, exiting"
    exit 0
fi

AUTOCONNECT=$(uci -q get network.wan.autoconnect)
if [ ${AUTOCONNECT} != "1" ]; then
    logger "exec: /usr/bin/watchdog_mbim WAN autoconnect is disabled, exiting"
    exit 0
fi

while true; do
    LTESTATUS=$(uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-data-status)
    LTEERROR=$?
    LTEFIND=$(echo ${LTESTATUS} | grep "\"connected\"" | wc -l)

    if [ ${LTEERROR} -ne 0 ]; then
        LTE123=$(uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-device-operating-mode)
        logger "exec: /usr/bin/watchdog_mbim ${LTE123} uqmi not response into 20 sec exec ifdown wan; ifup wan"
        ifdown wan && ifup wan
    fi

    if [ ${LTEFIND} -eq "0" ]; then
        LTE123=$(uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-device-operating-mode)
        logger "exec: /usr/bin/watchdog_mbim ${LTE123} lost connection detected exec ifdown wan; ifup wan"
        ifdown wan && ifup wan
    fi

    sleep 10

    #LTE123=$(uqmi -m -d /dev/cdc-wdm0 -t 20000 --get-device-operating-mode)
    #logger "exec: /usr/bin/watchdog_mbim ${LTESTATUS} ${LTEERROR} ${LTEFIND} ${LTE123}"    

done

exit 0
