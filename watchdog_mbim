#!/bin/sh /etc/rc.common

# show this document: https://github.com/openwrt/packages/blob/0ec95bd1f4dc9b829081bfd7910220d530517591/net/netbird/files/netbird.init#L3
# exec: ip link show wwan0; ip monitor link dev wwan0
. /lib/netifd/netifd-proto.sh


USE_PROCD=1
START=99

PROGRAM="/root/watchdog_mbim"
PID_FILE="/var/run/watchdog_mbim.pid"

boot() {
        # show this document: "https://github.com/openwrt/packages/commit/e5613b306f890da5ca2e6401bc587d67815dfc93"
        # during boot it does nothing
        return 0

        # show this document: "https://github.com/compact21/watchdog_mbim/blob/main/README.md#edit-the-etcrclocal-file-which-will-look-something-like-this"
        # add echo "service watchdog_mbim start" | at now+10minutes into /etc/rc.local first exit 0
}

start_service() {
        procd_open_instance
        procd_set_param term_timeout 240 # wait before sending SIGKILL
        procd_set_param command $PROGRAM
        procd_set_param pidfile "$PID_FILE"
        procd_set_param respawn 150 10 10
        procd_set_param stdout 1
        procd_set_param stderr 1
        procd_close_instance
}

service_triggers() {
        # from "https://forum.openwrt.org/t/procd-init-interface-trigger-for-non-daemon-executables-that-are-not-running-permanently/58258/8"

        # cat /tmp/mnt/usb_log/crash_watchdog_mbim | grep crash
        # Fri Jun 27 15:25:10 2025 daemon.info procd: Instance watchdog_mbim::instance1 s in a crash loop 6 crashes, 228 seconds since last crash

        # triggers test, after giving the "ifdown wan" command you should see an event with the command:
        # ubus monitor | grep '"method":"up","data":{"interface":"wan"}}'
        # and as a consequence of this it should restart the service
        procd_open_trigger
        procd_add_interface_trigger "interface.*.up" "wan" "/etc/init.d/watchdog_mbim restart"
        procd_close_trigger
}
