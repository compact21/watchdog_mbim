#!/bin/sh /etc/rc.common

USE_PROCD=1
START=99

PROG="/root/bin/watchdog_mbim"
PID_FILE="/var/run/watchdog_mbim.pid"
CONFIG_FILE="/etc/watchdog_mbim.conf"
LOGHEADER="watchdog_mbim"

# Optional debug files (enable via touching)
WATCHDOG_DEBUG_FILE="/tmp/watchdog/mbim_debug"

# Configuration check require
if [ ! -f "$CONFIG_FILE" ]; then
    logger -t "$LOGHEADER" "Configuration file $CONFIG_FILE missing, exiting"
    exit 1
fi

boot() {
        # Service must NOT start automatically at boot.
        # It is started manually ~10 minutes after boot (via rc.local / at).
        return 0
}

start_service() {
    logger -t "$LOGHEADER" "Starting watchdog_mbim service"

    procd_open_instance
    procd_set_param command "$PROG"
    procd_set_param respawn 3 10 60
    procd_set_param pidfile "$PID_FILE"
    procd_set_param term_timeout 60
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
}


stop_service() {
    logger -t "$LOGHEADER" "Stopping watchdog_mbim service"
}

help() {
    echo
    echo "WATCHDOG_MBIM - minimal init.d wrapper"
    echo "-------------------------------------"
    echo "Commands:"
    echo "  start    Start the watchdog daemon"
    echo "  stop     Stop the watchdog daemon"
    echo "  restart  Restart the watchdog daemon"
    echo "  help     Show this message"
    echo
    echo "Configuration file: $CONFIG_FILE"
    echo
    echo "Debug mode: $( [ -f "$WATCHDOG_DEBUG_FILE" ] && echo ENABLED || echo DISABLED )"
    echo
    echo "To enable debug logging:"
    echo "  touch $WATCHDOG_DEBUG_FILE"
    echo
    echo "To disable debug logging:"
    echo "  rm -f $WATCHDOG_DEBUG_FILE"
    echo
}

#service_triggers() {
#        # from "https://forum.openwrt.org/t/procd-init-interface-trigger-for-non-daemon-executables-that-are-not-running-permanently/58258/8"
#
#        # triggers test, after giving the "ifdown wan" command you should see an event with the command:
#        # ubus monitor | grep '"method":"up","data":{"interface":"wan"}}'
#        # and as a consequence of this it should restart the service
#        procd_open_trigger
#        procd_add_interface_trigger "interface.*.up" "wan" "/etc/init.d/watchdog_mbim restart"
#        procd_close_trigger
#}
