#!/bin/sh /etc/rc.common

USE_PROCD=1

START=99

PROGRAM="/root/watchdog_mbim"

PID_FILE="/var/run/watchdog_mbim.pid"

boot() {
        # add "at" package with the commands:
        # opkg update; opkg install at
        #
        # edit /etc/rc.local and add this line before "exit 0"
        # echo "service watchdog_mbim start" | at now+10minutes
        #
        # during boot it does nothing
        return 0
        #
        # service | grep watchdog_mbim
        # /etc/init.d/watchdog_mbim         disabled         running
}


start_service() {
        procd_open_instance
        procd_set_param term_timeout 240
        procd_set_param command $PROGRAM
        procd_set_param pidfile "$PID_FILE"
        procd_set_param respawn
        procd_set_param stdout 1
        procd_set_param stderr 1
        procd_close_instance
}


service_triggers() {
        #
        # from "https://forum.openwrt.org/t/procd-init-interface-trigger-for-non-daemon-executables-that-are-not-running-permanently/58258/8"
        #
        # when it detects an event on the defined interface it does the operation, it helps debugging the service
        # after giving the "ifdown wan" command you should see an event with the command:
        #
        # ubus monitor | grep '"method":"up","data":{"interface":"wan"}}'
        #
        # and as a consequence of this it should restart the service
        #
        procd_open_trigger
        procd_add_interface_trigger "interface.*.up" "wan" /etc/init.d/watchdog_mbim restart
        procd_close_trigger
}
